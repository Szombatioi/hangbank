"use client";
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { createTheme, ThemeProvider } from "@mui/material/styles";
import { Button, CircularProgress, CssBaseline } from "@mui/material";
import { LanguageProvider, useLanguage } from "./contexts/LanguageContext";
import { Severity, SnackbarProvider, useSnackbar } from "./contexts/SnackbarProvider";
import { SessionProvider, useSession } from "next-auth/react";
import { usePathname, useRouter } from "next/navigation";
import { ReactNode, useEffect } from "react";
import { signOut } from "next-auth/react";
import Navbar from "./components/navbar";
import api from "./axios";
import { useTranslation } from "react-i18next";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

// export const metadata: Metadata = {
//   title: "Create Next App",
//   description: "Generated by create next app",
// };

const theme = createTheme({
  palette: {
    background: {
      default: "#fff0db",
      //   paper: "#1F0812"
    },
    // primary: {
    //   main: "#746D75", // default blue
    // },
    // secondary: {
    //   main: "#121619", // optional
    // },
  },
});

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const router = useRouter();
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable}`}
        style={{}}
      >
        <ThemeProvider theme={theme}>
          <SessionProvider>
            <AuthGuard>
              <CssBaseline />
              <LanguageProvider>
                <SnackbarProvider>{children}</SnackbarProvider>
              </LanguageProvider>
            </AuthGuard>
          </SessionProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}

function AuthGuard({ children }: { children: ReactNode }) {
  const { data: session, status } = useSession();
  const router = useRouter();
  const pathname = usePathname();
  const {setLanguage} = useLanguage();
  const {showMessage} = useSnackbar();
  const {t} = useTranslation("common");

  useEffect(() => {
    const isAuthPage = pathname.startsWith("/auth");
    if (status === "unauthenticated" && !isAuthPage) {
      router.push("/auth/login");
    }
  }, [status, router, pathname]);

  useEffect(() => {
    async function fetchUserSettings(){
      try{
        const settings = await api.get<{language: {
          id: string,
          code: string,
          name: string
        }}>(`/user-settings/${session?.user.id}`);
        setLanguage(settings.data.language.code.split("-")[0]);
      }catch(err){
        showMessage(t("fetch_settings_fail"), Severity.error);
      }

    }
  }, []);

  if (status === "loading")
    return (
      <div style={{ textAlign: "center" }}>
        <CircularProgress />
      </div>
    );

  return (
    <>
      {session && (
        <Navbar
          signOutCallback={(options) =>
            signOut({ callbackUrl: "/", ...options })
          }
        />
      )}
      {children}
    </>
  );
}
